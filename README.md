# Ansible Collection - GNOME Lockdown

> **NOTE:** This project is in a beta state. Testing is ongoing.

This Ansible collection provides a suite of autogenerated modules to manage and enforce GNOME desktop environment settings. It allows administrators to configure GSettings keys and lock them down to prevent user modifications, making it ideal for maintaining consistent desktop environments in enterprise or multi-user setups.

## Overview

The core of this collection is a Python-based generator that reads GNOME's GSettings XML schema files and creates idempotent Ansible modules for each schema. This approach ensures that the Ansible modules are always up-to-date with the available GSettings and provides a consistent and predictable way to manage the GNOME desktop.

Each generated module allows you to:
- Set any key to a specific value within a GSettings schema.
- Lock any key to prevent it from being changed by users.

### Advantages vs community.general.dconf

1. Schema Based
    - All modules are generated based on GSettings schemas.
    - Allows for easy updating and forking.
2. Type safe
    - Schemas contain type information, this type information is used to ensure that invalid values are not written to the dconf database.
    - The GSettings types are marshalled and unmarshalled by the [pygvariant](https://github.com/Smurf/pygvariant/tree/master) library.
3. Idempotent by default
    - No more having to check if files or values exist before calling dconf manually.

## Usage

Here is an example of how to use one of the generated modules to configure the GNOME desktop interface settings. This example sets the clock to show the date and weekday, and locks the setting to prevent users from changing it.

```yaml
- name: Configure and Lock GNOME Desktop Interface Settings
  hosts: workstations
  tasks:
    - name: Set clock format and lock it
      become: yes
      org_gnome_desktop_interface:
        clock-show-date: true
        clock-show-weekday: true
        clock-show-weekday_locked: true
```

In this example, `org_gnome_desktop_interface` is the generated Ansible module corresponding to the `org.gnome.desktop.interface` GSettings schema.

# Development

Some notes on developing ansible-gnome-lockdown.

## How It Works

The modules are generated using a combination of scripts and templates:

- **`generator.py`**: This is the main script that parses the GSettings XML schema files. It reads the schema definitions, extracts the keys, types, and default values, and then uses a Jinja2 template to create a Python-based Ansible module for each schema.

- **`schemas.list`**: This file contains a list of paths to the GSettings XML schema files that should be processed. You can add or remove schemas from this list to control which modules get generated.

- **`base_module_template.j2`**: This is a Jinja2 template that defines the structure of the generated Ansible modules. It includes the Ansible module documentation, the module's logic for setting and locking keys, and the idempotency checks.

- **`build_modules.sh`**: This script orchestrates the module generation process by running `generator.py` with the `schemas.list` file as input.

The generated modules are placed in the `plugins/modules/` directory, making them available for use in your Ansible playbooks.


## Generating Modules

To generate or regenerate the Ansible modules, you can run the `build_modules.sh` script:

```bash
# Rebuild everything
./rebuild.sh
# Just to buid the docs
# NOTE: This uses the INSTALLED Collection
./build_docs.sh
# Just to generate the modules
./build_modules.sh
```

This will process the schemas listed in `schemas.list` and create the corresponding Ansible modules in the `plugins/modules/` directory. If you want to generate modules for custom or additional schemas, simply add the path to the XML schema file to `schemas.list` and run the script again.

## Dependencies

The module generator has the following Python dependencies:

- `jinja2`
- `pygvariant`
- `PyYAML`

You can install them using pip:

```bash
pip install -r meta/ee-requirements.txt
```
