#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_desktop_interface
short_description: Manages GNOME GSettings for org.gnome.desktop.interface
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.desktop.interface' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  toolkit-accessibility:
    description:
      - >
        Enable Toolkit Accessibility
      - >
        Whether toolkits should load accessibility related modules.
    type: bool
    default: false
  toolkit-accessibility_locked:
    description:
      - >
        If set to true, locks the 'toolkit-accessibility' key to prevent user modification.
    type: bool
    default: false
  enable-animations:
    description:
      - >
        Enable Animations
      - >
        Whether animations should be displayed. Note: This is a global key, it changes the behaviour of the window manager, the panel etc.
    type: bool
    default: true
  enable-animations_locked:
    description:
      - >
        If set to true, locks the 'enable-animations' key to prevent user modification.
    type: bool
    default: false
  menus-have-tearoff:
    description:
      - >
        Menus Have Tearoff
      - >
        Whether menus should have a tearoff.
    type: bool
    default: false
  menus-have-tearoff_locked:
    description:
      - >
        If set to true, locks the 'menus-have-tearoff' key to prevent user modification.
    type: bool
    default: false
  can-change-accels:
    description:
      - >
        Can Change Accels
      - >
        Whether the user can dynamically type a new accelerator when positioned over an active menuitem.
    type: bool
    default: false
  can-change-accels_locked:
    description:
      - >
        If set to true, locks the 'can-change-accels' key to prevent user modification.
    type: bool
    default: false
  toolbar-style:
    description:
      - >
        Toolbar Style
      - >
        Toolbar Style. Valid values are “both”, “both-horiz”, “icons”, and “text”.
    type: str
    default: >
             both-horiz
  toolbar-style_locked:
    description:
      - >
        If set to true, locks the 'toolbar-style' key to prevent user modification.
    type: bool
    default: false
  menubar-detachable:
    description:
      - >
        Menubar Detachable
      - >
        Whether the user can detach menubars and move them around.
    type: bool
    default: false
  menubar-detachable_locked:
    description:
      - >
        If set to true, locks the 'menubar-detachable' key to prevent user modification.
    type: bool
    default: false
  toolbar-detachable:
    description:
      - >
        Toolbar Detachable
      - >
        Whether the user can detach toolbars and move them around.
    type: bool
    default: false
  toolbar-detachable_locked:
    description:
      - >
        If set to true, locks the 'toolbar-detachable' key to prevent user modification.
    type: bool
    default: false
  toolbar-icons-size:
    description:
      - >
        Toolbar Icon Size
      - >
        Size of icons in toolbars, either “small” or “large”.
    type: str
    default: >
             large
  toolbar-icons-size_locked:
    description:
      - >
        If set to true, locks the 'toolbar-icons-size' key to prevent user modification.
    type: bool
    default: false
  cursor-blink:
    description:
      - >
        Cursor Blink
      - >
        Whether the cursor should blink.
    type: bool
    default: true
  cursor-blink_locked:
    description:
      - >
        If set to true, locks the 'cursor-blink' key to prevent user modification.
    type: bool
    default: false
  cursor-blink-time:
    description:
      - >
        Cursor Blink Time
      - >
        Length of the cursor blink cycle, in milliseconds.
    type: int
    default: 1200
  cursor-blink-time_locked:
    description:
      - >
        If set to true, locks the 'cursor-blink-time' key to prevent user modification.
    type: bool
    default: false
  cursor-blink-timeout:
    description:
      - >
        Cursor Blink Timeout
      - >
        Time after which the cursor stops blinking, in seconds.
    type: int
    default: 10
  cursor-blink-timeout_locked:
    description:
      - >
        If set to true, locks the 'cursor-blink-timeout' key to prevent user modification.
    type: bool
    default: false
  icon-theme:
    description:
      - >
        Icon Theme
      - >
        Icon theme to use for the panel, nautilus etc.
    type: str
    default: >
             Adwaita
  icon-theme_locked:
    description:
      - >
        If set to true, locks the 'icon-theme' key to prevent user modification.
    type: bool
    default: false
  gtk-theme:
    description:
      - >
        Gtk+ Theme
      - >
        Basename of the default theme used by gtk+.
    type: str
    default: >
             Adwaita
  gtk-theme_locked:
    description:
      - >
        If set to true, locks the 'gtk-theme' key to prevent user modification.
    type: bool
    default: false
  gtk-key-theme:
    description:
      - >
        Gtk+ Keybinding Theme
      - >
        Basename of the default keybinding theme used by gtk+.
    type: str
    default: >
             Default
  gtk-key-theme_locked:
    description:
      - >
        If set to true, locks the 'gtk-key-theme' key to prevent user modification.
    type: bool
    default: false
  font-name:
    description:
      - >
        Default font
      - >
        Name of the default font used by gtk+.
    type: str
    default: >
             Adwaita Sans 11
  font-name_locked:
    description:
      - >
        If set to true, locks the 'font-name' key to prevent user modification.
    type: bool
    default: false
  avatar-directories:
    description:
      - >
        Directories with avatar faces
      - >
        Directories to override the default avatar faces installed by gnome-control-center.
    type: str
    default: >
             []
  avatar-directories_locked:
    description:
      - >
        If set to true, locks the 'avatar-directories' key to prevent user modification.
    type: bool
    default: false
  text-scaling-factor:
    description:
      - >
        Text scaling factor
      - >
        Factor used to enlarge or reduce text display, without changing font size.
    type: str
    default: >
             1.0
  text-scaling-factor_locked:
    description:
      - >
        If set to true, locks the 'text-scaling-factor' key to prevent user modification.
    type: bool
    default: false
  scaling-factor:
    description:
      - >
        Window scaling factor
      - >
        Integer factor used to scale windows by. For use on high-dpi screens. 0 means pick automatically based on monitor.
    type: str
    default: >
             0
  scaling-factor_locked:
    description:
      - >
        If set to true, locks the 'scaling-factor' key to prevent user modification.
    type: bool
    default: false
  gtk-im-preedit-style:
    description:
      - >
        GTK IM Preedit Style
      - >
        Name of the GTK+ input method Preedit Style used by gtk+.
    type: str
    default: >
             callback
  gtk-im-preedit-style_locked:
    description:
      - >
        If set to true, locks the 'gtk-im-preedit-style' key to prevent user modification.
    type: bool
    default: false
  gtk-im-status-style:
    description:
      - >
        GTK IM Status Style
      - >
        Name of the GTK+ input method Status Style used by gtk+.
    type: str
    default: >
             callback
  gtk-im-status-style_locked:
    description:
      - >
        If set to true, locks the 'gtk-im-status-style' key to prevent user modification.
    type: bool
    default: false
  gtk-im-module:
    description:
      - >
        GTK IM Module
      - >
        Name of the input method module used by GTK+.
    type: str
    default: ""
  gtk-im-module_locked:
    description:
      - >
        If set to true, locks the 'gtk-im-module' key to prevent user modification.
    type: bool
    default: false
  document-font-name:
    description:
      - >
        Document font
      - >
        Name of the default font used for reading documents.
    type: str
    default: >
             Adwaita Sans 11
  document-font-name_locked:
    description:
      - >
        If set to true, locks the 'document-font-name' key to prevent user modification.
    type: bool
    default: false
  monospace-font-name:
    description:
      - >
        Monospace font
      - >
        Name of a monospaced (fixed-width) font for use in locations like terminals.
    type: str
    default: >
             Adwaita Mono 11
  monospace-font-name_locked:
    description:
      - >
        If set to true, locks the 'monospace-font-name' key to prevent user modification.
    type: bool
    default: false
  menubar-accel:
    description:
      - >
        Menubar accelerator
      - >
        Keyboard shortcut to open the menu bars.
    type: str
    default: >
             F10
  menubar-accel_locked:
    description:
      - >
        If set to true, locks the 'menubar-accel' key to prevent user modification.
    type: bool
    default: false
  cursor-theme:
    description:
      - >
        Cursor theme
      - >
        Cursor theme name. Used only by Xservers that support the Xcursor extension.
    type: str
    default: >
             Adwaita
  cursor-theme_locked:
    description:
      - >
        If set to true, locks the 'cursor-theme' key to prevent user modification.
    type: bool
    default: false
  cursor-size:
    description:
      - >
        Cursor size
      - >
        Size of the cursor used as cursor theme.
    type: int
    default: 24
  cursor-size_locked:
    description:
      - >
        If set to true, locks the 'cursor-size' key to prevent user modification.
    type: bool
    default: false
  gtk-timeout-initial:
    description:
      - >
        Timeout before click repeat
      - >
        Timeout in milliseconds before a click starts repeating (on spinner buttons for example).
    type: int
    default: 200
  gtk-timeout-initial_locked:
    description:
      - >
        If set to true, locks the 'gtk-timeout-initial' key to prevent user modification.
    type: bool
    default: false
  gtk-timeout-repeat:
    description:
      - >
        Timeout between click repeats
      - >
        Timeout in milliseconds between repeated clicks when a button is left pressed.
    type: int
    default: 20
  gtk-timeout-repeat_locked:
    description:
      - >
        If set to true, locks the 'gtk-timeout-repeat' key to prevent user modification.
    type: bool
    default: false
  gtk-color-palette:
    description:
      - >
        Palette used in the color selector
      - >
        Palette used in the color selector as defined by the “gtk-color-palette” setting
    type: str
    default: >
             black:white:gray50:red:purple:blue:light blue:green:yellow:orange:lavender:brown:goldenrod4:dodger blue:pink:light green:gray10:gray30:gray75:gray90
  gtk-color-palette_locked:
    description:
      - >
        If set to true, locks the 'gtk-color-palette' key to prevent user modification.
    type: bool
    default: false
  gtk-color-scheme:
    description:
      - >
        List of symbolic names and color equivalents
      - >
        A “\n” separated list of “name:color” as defined by the “gtk-color-scheme” setting
    type: str
    default: ""
  gtk-color-scheme_locked:
    description:
      - >
        If set to true, locks the 'gtk-color-scheme' key to prevent user modification.
    type: bool
    default: false
  clock-format:
    description:
      - >
        Whether the clock displays in 24h or 12h format
      - >
        Whether the clock displays in 24h or 12h format
    type: str
    default: >
             24h
  clock-format_locked:
    description:
      - >
        If set to true, locks the 'clock-format' key to prevent user modification.
    type: bool
    default: false
  clock-show-seconds:
    description:
      - >
        Whether the clock shows seconds
      - >
        If true, display seconds in the clock.
    type: bool
    default: false
  clock-show-seconds_locked:
    description:
      - >
        If set to true, locks the 'clock-show-seconds' key to prevent user modification.
    type: bool
    default: false
  clock-show-date:
    description:
      - >
        Show date in clock
      - >
        If true, display date in the clock, in addition to time.
    type: bool
    default: true
  clock-show-date_locked:
    description:
      - >
        If set to true, locks the 'clock-show-date' key to prevent user modification.
    type: bool
    default: false
  clock-show-weekday:
    description:
      - >
        Show weekday in clock
      - >
        If true, display weekday in the clock, in addition to time.
    type: bool
    default: false
  clock-show-weekday_locked:
    description:
      - >
        If set to true, locks the 'clock-show-weekday' key to prevent user modification.
    type: bool
    default: false
  enable-hot-corners:
    description:
      - >
        Enable hot corners
      - >
        If true, the activities overview can be accessed by moving the mouse to the top-left corner.
    type: bool
    default: true
  enable-hot-corners_locked:
    description:
      - >
        If set to true, locks the 'enable-hot-corners' key to prevent user modification.
    type: bool
    default: false
  show-battery-percentage:
    description:
      - >
        Show battery percentage
      - >
        If true, display battery percentage in the status menu, in addition to the icon.
    type: bool
    default: false
  show-battery-percentage_locked:
    description:
      - >
        If set to true, locks the 'show-battery-percentage' key to prevent user modification.
    type: bool
    default: false
  gtk-enable-primary-paste:
    description:
      - >
        Enable the primary paste selection
      - >
        If true, gtk+ uses the primary paste selection, usually triggered by a middle mouse button click.
    type: bool
    default: true
  gtk-enable-primary-paste_locked:
    description:
      - >
        If set to true, locks the 'gtk-enable-primary-paste' key to prevent user modification.
    type: bool
    default: false
  overlay-scrolling:
    description:
      - >
        Allow overlay scrolling
      - >
        Whether scrollbars should be overlayed as indicators. Depending on input devices in use, permanent scrollbars may still be displayed.
    type: bool
    default: true
  overlay-scrolling_locked:
    description:
      - >
        If set to true, locks the 'overlay-scrolling' key to prevent user modification.
    type: bool
    default: false
  locate-pointer:
    description:
      - >
        Highlights the current location of the pointer.
      - >
        If true, pressing a key will highlight the current pointer location on screen.
    type: bool
    default: false
  locate-pointer_locked:
    description:
      - >
        If set to true, locks the 'locate-pointer' key to prevent user modification.
    type: bool
    default: false
  font-antialiasing:
    description:
      - >
        Antialiasing
      - >
        The type of antialiasing to use when rendering fonts. Possible values are: “none” for no antialiasing, “grayscale” for standard grayscale antialiasing, and “rgba” for subpixel antialiasing (LCD screens only).
    type: str
    default: >
             grayscale
  font-antialiasing_locked:
    description:
      - >
        If set to true, locks the 'font-antialiasing' key to prevent user modification.
    type: bool
    default: false
  font-hinting:
    description:
      - >
        Hinting
      - >
        The type of hinting to use when rendering fonts. Possible values are: “none” for no hinting and “slight” for fitting only to the Y-axis like Microsoft’s ClearType, DirectWrite and Adobe’s proprietary font rendering engine. Ignores native hinting within the font, generates hints algorithmically. Used on Ubuntu by default. Recommended. The meaning of “medium” and “full” depends on the font format (.ttf, .otf, .pfa/.pfb) and the installed version of FreeType. They usually try to fit glyphs to both the X and the Y axis (except for .otf: Y-only). This can lead to distortion and/or inconsistent rendering depending on the quality of the font, the font format and the state of FreeType’s font engines.
    type: str
    default: >
             slight
  font-hinting_locked:
    description:
      - >
        If set to true, locks the 'font-hinting' key to prevent user modification.
    type: bool
    default: false
  font-rgba-order:
    description:
      - >
        RGBA order
      - >
        The order of subpixel elements on an LCD screen; only used when antialiasing is set to “rgba”. Possible values are: “rgb” for red on left (most common), “bgr” for blue on left, “vrgb” for red on top, “vbgr” for red on bottom.
    type: str
    default: >
             rgb
  font-rgba-order_locked:
    description:
      - >
        If set to true, locks the 'font-rgba-order' key to prevent user modification.
    type: bool
    default: false
  color-scheme:
    description:
      - >
        Color scheme
      - >
        The preferred color scheme for the user interface. Valid values are “default”, “prefer-dark”, “prefer-light”.
    type: str
    default: >
             default
  color-scheme_locked:
    description:
      - >
        If set to true, locks the 'color-scheme' key to prevent user modification.
    type: bool
    default: false
  font-rendering:
    description:
      - >
        Font rendering
      - >
        Preference to indicate whether font rendering should follow the low-level `font-hinting` and `font-antialiasing` and `font-rgba-order` settings, or take environmental factors such as screen resolution and scaling into account. Possible values are: "manual" for respecting the low-level settings, or "automatic" for letting the toolkit make its own decisions.
    type: str
    default: >
             automatic
  font-rendering_locked:
    description:
      - >
        If set to true, locks the 'font-rendering' key to prevent user modification.
    type: bool
    default: false
  accent-color:
    description:
      - >
        Accent color
      - >
        The preferred accent color for the user interface. Valid values are "blue", "teal", "green", "yellow", "orange", "red", "pink", "purple", "slate".
    type: str
    default: >
             blue
  accent-color_locked:
    description:
      - >
        If set to true, locks the 'accent-color' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.desktop.interface
  org_gnome_desktop_interface:
    toolkit-accessibility: false
    toolkit-accessibility_locked: true
    enable-animations: true
    enable-animations_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'toolkit-accessibility': {
            'type': 'bool',
            'default': True
        },
        'enable-animations': {
            'type': 'bool',
            'default': True
        },
        'menus-have-tearoff': {
            'type': 'bool',
            'default': True
        },
        'can-change-accels': {
            'type': 'bool',
            'default': True
        },
        'toolbar-style': {
            'type': 'str',
            'default': "both-horiz"
        },
        'menubar-detachable': {
            'type': 'bool',
            'default': True
        },
        'toolbar-detachable': {
            'type': 'bool',
            'default': True
        },
        'toolbar-icons-size': {
            'type': 'str',
            'default': "large"
        },
        'cursor-blink': {
            'type': 'bool',
            'default': True
        },
        'cursor-blink-time': {
            'type': 'int',
            'default': 1200
        },
        'cursor-blink-timeout': {
            'type': 'int',
            'default': 10
        },
        'icon-theme': {
            'type': 'str',
            'default': "Adwaita"
        },
        'gtk-theme': {
            'type': 'str',
            'default': "Adwaita"
        },
        'gtk-key-theme': {
            'type': 'str',
            'default': "Default"
        },
        'font-name': {
            'type': 'str',
            'default': "Adwaita Sans 11"
        },
        'avatar-directories': {
            'type': 'str',
            'default': "[]"
        },
        'text-scaling-factor': {
            'type': 'str',
            'default': "1.0"
        },
        'scaling-factor': {
            'type': 'str',
            'default': "0"
        },
        'gtk-im-preedit-style': {
            'type': 'str',
            'default': "callback"
        },
        'gtk-im-status-style': {
            'type': 'str',
            'default': "callback"
        },
        'gtk-im-module': {
            'type': 'str',
            'default': ''
        },
        'document-font-name': {
            'type': 'str',
            'default': "Adwaita Sans 11"
        },
        'monospace-font-name': {
            'type': 'str',
            'default': "Adwaita Mono 11"
        },
        'menubar-accel': {
            'type': 'str',
            'default': "F10"
        },
        'cursor-theme': {
            'type': 'str',
            'default': "Adwaita"
        },
        'cursor-size': {
            'type': 'int',
            'default': 24
        },
        'gtk-timeout-initial': {
            'type': 'int',
            'default': 200
        },
        'gtk-timeout-repeat': {
            'type': 'int',
            'default': 20
        },
        'gtk-color-palette': {
            'type': 'str',
            'default': "black:white:gray50:red:purple:blue:light blue:green:yellow:orange:lavender:brown:goldenrod4:dodger blue:pink:light green:gray10:gray30:gray75:gray90"
        },
        'gtk-color-scheme': {
            'type': 'str',
            'default': ''
        },
        'clock-format': {
            'type': 'str',
            'default': "24h"
        },
        'clock-show-seconds': {
            'type': 'bool',
            'default': True
        },
        'clock-show-date': {
            'type': 'bool',
            'default': True
        },
        'clock-show-weekday': {
            'type': 'bool',
            'default': True
        },
        'enable-hot-corners': {
            'type': 'bool',
            'default': True
        },
        'show-battery-percentage': {
            'type': 'bool',
            'default': True
        },
        'gtk-enable-primary-paste': {
            'type': 'bool',
            'default': True
        },
        'overlay-scrolling': {
            'type': 'bool',
            'default': True
        },
        'locate-pointer': {
            'type': 'bool',
            'default': True
        },
        'font-antialiasing': {
            'type': 'str',
            'default': "grayscale"
        },
        'font-hinting': {
            'type': 'str',
            'default': "slight"
        },
        'font-rgba-order': {
            'type': 'str',
            'default': "rgb"
        },
        'color-scheme': {
            'type': 'str',
            'default': "default"
        },
        'font-rendering': {
            'type': 'str',
            'default': "automatic"
        },
        'accent-color': {
            'type': 'str',
            'default': "blue"
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org_gnome_desktop_interface")
    lock_file_path = os.path.join(locks_dir, "ansible-org_gnome_desktop_interface")

    schema_full_path = "/org/gnome/desktop/interface/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
