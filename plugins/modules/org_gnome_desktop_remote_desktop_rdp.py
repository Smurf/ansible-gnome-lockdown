#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_desktop_remote_desktop_rdp
short_description: Manages GNOME GSettings for org.gnome.desktop.remote-desktop.rdp
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.desktop.remote-desktop.rdp' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.1.0"
options:
  port:
    description:
    - The port used by the RDP server
    - The RDP client will connect to this port to use this RDP server.
    type: str
    default: 3389

  port_locked:
    description:
    - >
      If set to true, locks the 'port' key to prevent user modification.
    type: bool
    default: false
  negotiate-port:
    description:
    - Search a different RDP port if the configured one is used
    - "When negotiate-port is set to 'true' the RDP server will attempt to\n        listen\
      \ to the first available of the next 10 ports starting from the\n        configured\
      \ one."
    type: bool
    default: true

  negotiate-port_locked:
    description:
    - >
      If set to true, locks the 'negotiate-port' key to prevent user modification.
    type: bool
    default: false
  enable:
    description:
    - Whether the RDP backend is enabled or not
    - If set to 'true' the RDP backend will be initialized.
    type: bool
    default: false

  enable_locked:
    description:
    - >
      If set to true, locks the 'enable' key to prevent user modification.
    type: bool
    default: false
  screen-share-mode:
    description:
    - Screenshare mode of RDP connections
    - "The screenshare mode specifies, whether the RDP backend mirrors the\n        primary\
      \ screen, or whether a virtual monitor is created.\n\n        For the initial resolution\
      \ of the virtual monitor, the RDP backend uses\n        either the client core data\
      \ ([MS-RDPBCGR] 2.2.1.3.2) or the client\n        monitor data ([MS-RDPBCGR] 2.2.1.3.6),\
      \ depending on what is available.\n\n        When using a remote desktop session\
      \ with a virtual monitor, clients can\n        resize the resolution of the virtual\
      \ monitor during a session with the\n        Display Update Virtual Channel Extension\
      \ ([MS-RDPEDISP]).\n\n        Allowed screenshare modes include:\n\n         * mirror-primary\
      \ - Record the primary monitor of the current user\n                           \
      \ session.\n\n         * extend - Create a new virtual monitor and use it for the\
      \ remote\n                    desktop session.\n                    The resolution\
      \ of this virtual monitor is derived from the\n                    monitor configuration,\
      \ submitted by the remote desktop\n                    client."
    type: str
    default: mirror-primary

  screen-share-mode_locked:
    description:
    - >
      If set to true, locks the 'screen-share-mode' key to prevent user modification.
    type: bool
    default: false
  tls-cert:
    description:
    - Path to the certificate file
    - "In order to be able to use RDP with TLS Security, both the private key\n      \
      \  file and the certificate file need to be provided to the RDP server."
    type: str
    default: ''

  tls-cert_locked:
    description:
    - >
      If set to true, locks the 'tls-cert' key to prevent user modification.
    type: bool
    default: false
  tls-key:
    description:
    - Path to the private key file
    - "In order to be able to use RDP with TLS Security, both the private key\n      \
      \  file and the certificate file need to be provided to the RDP server."
    type: str
    default: ''

  tls-key_locked:
    description:
    - >
      If set to true, locks the 'tls-key' key to prevent user modification.
    type: bool
    default: false
  view-only:
    description:
    - Only allow remote connections to view the screen content
    - "When view-only is true, remote RDP connections cannot manipulate input\n      \
      \  devices (e.g. mouse and keyboard)."
    type: bool
    default: true

  view-only_locked:
    description:
    - >
      If set to true, locks the 'view-only' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.desktop.remote-desktop.rdp
  org_gnome_desktop_remote_desktop_rdp:
    port: 3389

    negotiate-port: true

    enable: false

    screen-share-mode: mirror-primary

    tls-cert: ''

    tls-key: ''

    view-only: true

'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""
    # We have to do gross stuff with the bools here.
    keys_spec = {
        'port': {
            'default': 3389,
            'type': 'str',
            'gtype':'q',
        },
        'negotiate-port': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'enable': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'screen-share-mode': {
            'default': 'mirror-primary',
            'type': 'str',
            'gtype':'s',
        },
        'tls-cert': {
            'default': '',
            'type': 'str',
            'gtype':'s',
        },
        'tls-key': {
            'default': '',
            'type': 'str',
            'gtype':'s',
        },
        'view-only': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org.gnome.desktop.remote-desktop.rdp")
    lock_file_path = os.path.join(locks_dir, "ansible-org.gnome.desktop.remote-desktop.rdp")

    schema_full_path = "/org/gnome/desktop/remote-desktop/rdp/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
