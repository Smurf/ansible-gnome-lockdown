#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_settings-daemon_plugins_media-keys_deprecated
short_description: Manages GNOME GSettings for org.gnome.settings-daemon.plugins.media-keys.deprecated
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.settings-daemon.plugins.media-keys.deprecated' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  calculator:
    description:
      - >
        Launch calculator
      - >
        Binding to launch the calculator.
    type: str
    default: "XF86Calculator"
  calculator_locked:
    description:
      - >
        If set to true, locks the 'calculator' key to prevent user modification.
    type: bool
    default: false
  control-center:
    description:
      - >
        Launch settings
      - >
        Binding to launch GNOME Settings.
    type: str
    default: "XF86Tools"
  control-center_locked:
    description:
      - >
        If set to true, locks the 'control-center' key to prevent user modification.
    type: bool
    default: false
  email:
    description:
      - >
        Launch email client
      - >
        Binding to launch the email client.
    type: str
    default: "XF86Mail"
  email_locked:
    description:
      - >
        If set to true, locks the 'email' key to prevent user modification.
    type: bool
    default: false
  eject:
    description:
      - >
        Eject
      - >
        Binding to eject an optical disc.
    type: str
    default: "XF86Eject"
  eject_locked:
    description:
      - >
        If set to true, locks the 'eject' key to prevent user modification.
    type: bool
    default: false
  help:
    description:
      - >
        Launch help browser
      - >
        Binding to launch the help browser.
    type: str
    default: ""
  help_locked:
    description:
      - >
        If set to true, locks the 'help' key to prevent user modification.
    type: bool
    default: false
  home:
    description:
      - >
        Home folder
      - >
        Binding to open the Home folder.
    type: str
    default: "XF86Explorer"
  home_locked:
    description:
      - >
        If set to true, locks the 'home' key to prevent user modification.
    type: bool
    default: false
  media:
    description:
      - >
        Launch media player
      - >
        Binding to launch the media player.
    type: str
    default: "XF86AudioMedia"
  media_locked:
    description:
      - >
        If set to true, locks the 'media' key to prevent user modification.
    type: bool
    default: false
  next:
    description:
      - >
        Next track
      - >
        Binding to skip to next track.
    type: str
    default: "XF86AudioNext"
  next_locked:
    description:
      - >
        If set to true, locks the 'next' key to prevent user modification.
    type: bool
    default: false
  pause:
    description:
      - >
        Pause playback
      - >
        Binding to pause playback.
    type: str
    default: "XF86AudioPause"
  pause_locked:
    description:
      - >
        If set to true, locks the 'pause' key to prevent user modification.
    type: bool
    default: false
  play:
    description:
      - >
        Play (or play/pause)
      - >
        Binding to start playback (or toggle play/pause).
    type: str
    default: "XF86AudioPlay"
  play_locked:
    description:
      - >
        If set to true, locks the 'play' key to prevent user modification.
    type: bool
    default: false
  logout:
    description:
      - >
        Log out
      - >
        Binding to log out.
    type: str
    default: "<Control><Alt>Delete"
  logout_locked:
    description:
      - >
        If set to true, locks the 'logout' key to prevent user modification.
    type: bool
    default: false
  previous:
    description:
      - >
        Previous track
      - >
        Binding to skip to previous track.
    type: str
    default: "XF86AudioPrev"
  previous_locked:
    description:
      - >
        If set to true, locks the 'previous' key to prevent user modification.
    type: bool
    default: false
  screensaver:
    description:
      - >
        Lock screen
      - >
        Binding to lock the screen.
    type: str
    default: "<Super>l"
  screensaver_locked:
    description:
      - >
        If set to true, locks the 'screensaver' key to prevent user modification.
    type: bool
    default: false
  search:
    description:
      - >
        Search
      - >
        Binding to launch the search tool.
    type: str
    default: "XF86Search"
  search_locked:
    description:
      - >
        If set to true, locks the 'search' key to prevent user modification.
    type: bool
    default: false
  stop:
    description:
      - >
        Stop playback
      - >
        Binding to stop playback.
    type: str
    default: "XF86AudioStop"
  stop_locked:
    description:
      - >
        If set to true, locks the 'stop' key to prevent user modification.
    type: bool
    default: false
  volume-down:
    description:
      - >
        Volume down
      - >
        Binding to lower the volume.
    type: str
    default: "XF86AudioLowerVolume"
  volume-down_locked:
    description:
      - >
        If set to true, locks the 'volume-down' key to prevent user modification.
    type: bool
    default: false
  volume-mute:
    description:
      - >
        Volume mute/unmute
      - >
        Binding to mute/unmute the volume.
    type: str
    default: "XF86AudioMute"
  volume-mute_locked:
    description:
      - >
        If set to true, locks the 'volume-mute' key to prevent user modification.
    type: bool
    default: false
  volume-up:
    description:
      - >
        Volume up
      - >
        Binding to raise the volume.
    type: str
    default: "XF86AudioRaiseVolume"
  volume-up_locked:
    description:
      - >
        If set to true, locks the 'volume-up' key to prevent user modification.
    type: bool
    default: false
  mic-mute:
    description:
      - >
        Microphone mute/unmute
      - >
        Binding to mute/unmute the microphone.
    type: str
    default: "XF86AudioMicMute"
  mic-mute_locked:
    description:
      - >
        If set to true, locks the 'mic-mute' key to prevent user modification.
    type: bool
    default: false
  www:
    description:
      - >
        Launch web browser
      - >
        Binding to launch the web browser.
    type: str
    default: "XF86WWW"
  www_locked:
    description:
      - >
        If set to true, locks the 'www' key to prevent user modification.
    type: bool
    default: false
  magnifier:
    description:
      - >
        Toggle magnifier
      - >
        Binding to show the screen magnifier
    type: str
    default: "<Alt><Super>8"
  magnifier_locked:
    description:
      - >
        If set to true, locks the 'magnifier' key to prevent user modification.
    type: bool
    default: false
  screenreader:
    description:
      - >
        Toggle screen reader
      - >
        Binding to start the screen reader
    type: str
    default: "<Alt><Super>s"
  screenreader_locked:
    description:
      - >
        If set to true, locks the 'screenreader' key to prevent user modification.
    type: bool
    default: false
  on-screen-keyboard:
    description:
      - >
        Toggle on-screen keyboard
      - >
        Binding to show the on-screen keyboard
    type: str
    default: ""
  on-screen-keyboard_locked:
    description:
      - >
        If set to true, locks the 'on-screen-keyboard' key to prevent user modification.
    type: bool
    default: false
  increase-text-size:
    description:
      - >
        Increase text size
      - >
        Binding to increase the text size
    type: str
    default: ""
  increase-text-size_locked:
    description:
      - >
        If set to true, locks the 'increase-text-size' key to prevent user modification.
    type: bool
    default: false
  decrease-text-size:
    description:
      - >
        Decrease text size
      - >
        Binding to decrease the text size
    type: str
    default: ""
  decrease-text-size_locked:
    description:
      - >
        If set to true, locks the 'decrease-text-size' key to prevent user modification.
    type: bool
    default: false
  toggle-contrast:
    description:
      - >
        Toggle contrast
      - >
        Binding to toggle the interface contrast
    type: str
    default: ""
  toggle-contrast_locked:
    description:
      - >
        If set to true, locks the 'toggle-contrast' key to prevent user modification.
    type: bool
    default: false
  magnifier-zoom-in:
    description:
      - >
        Magnifier zoom in
      - >
        Binding for the magnifier to zoom in
    type: str
    default: "<Alt><Super>equal"
  magnifier-zoom-in_locked:
    description:
      - >
        If set to true, locks the 'magnifier-zoom-in' key to prevent user modification.
    type: bool
    default: false
  magnifier-zoom-out:
    description:
      - >
        Magnifier zoom out
      - >
        Binding for the magnifier to zoom out
    type: str
    default: "<Alt><Super>minus"
  magnifier-zoom-out_locked:
    description:
      - >
        If set to true, locks the 'magnifier-zoom-out' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.settings-daemon.plugins.media-keys.deprecated
  org_gnome_settings-daemon_plugins_media-keys_deprecated:
    calculator: "XF86Calculator"
    calculator_locked: true
    control-center: "XF86Tools"
    control-center_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'calculator': {
            'type': 'str',
            'default': "XF86Calculator"
        },
        'control-center': {
            'type': 'str',
            'default': "XF86Tools"
        },
        'email': {
            'type': 'str',
            'default': "XF86Mail"
        },
        'eject': {
            'type': 'str',
            'default': "XF86Eject"
        },
        'help': {
            'type': 'str',
            'default': ''
        },
        'home': {
            'type': 'str',
            'default': "XF86Explorer"
        },
        'media': {
            'type': 'str',
            'default': "XF86AudioMedia"
        },
        'next': {
            'type': 'str',
            'default': "XF86AudioNext"
        },
        'pause': {
            'type': 'str',
            'default': "XF86AudioPause"
        },
        'play': {
            'type': 'str',
            'default': "XF86AudioPlay"
        },
        'logout': {
            'type': 'str',
            'default': "<Control><Alt>Delete"
        },
        'previous': {
            'type': 'str',
            'default': "XF86AudioPrev"
        },
        'screensaver': {
            'type': 'str',
            'default': "<Super>l"
        },
        'search': {
            'type': 'str',
            'default': "XF86Search"
        },
        'stop': {
            'type': 'str',
            'default': "XF86AudioStop"
        },
        'volume-down': {
            'type': 'str',
            'default': "XF86AudioLowerVolume"
        },
        'volume-mute': {
            'type': 'str',
            'default': "XF86AudioMute"
        },
        'volume-up': {
            'type': 'str',
            'default': "XF86AudioRaiseVolume"
        },
        'mic-mute': {
            'type': 'str',
            'default': "XF86AudioMicMute"
        },
        'www': {
            'type': 'str',
            'default': "XF86WWW"
        },
        'magnifier': {
            'type': 'str',
            'default': "<Alt><Super>8"
        },
        'screenreader': {
            'type': 'str',
            'default': "<Alt><Super>s"
        },
        'on-screen-keyboard': {
            'type': 'str',
            'default': ''
        },
        'increase-text-size': {
            'type': 'str',
            'default': ''
        },
        'decrease-text-size': {
            'type': 'str',
            'default': ''
        },
        'toggle-contrast': {
            'type': 'str',
            'default': ''
        },
        'magnifier-zoom-in': {
            'type': 'str',
            'default': "<Alt><Super>equal"
        },
        'magnifier-zoom-out': {
            'type': 'str',
            'default': "<Alt><Super>minus"
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org_gnome_settings-daemon_plugins_media-keys_deprecated")
    lock_file_path = os.path.join(locks_dir, "ansible-org_gnome_settings-daemon_plugins_media-keys_deprecated")

    schema_full_path = "None"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f"'{param_value}'"
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
