#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_shell
short_description: Manages GNOME GSettings for org.gnome.shell
description:
  - This module allows for the configuration of GSettings keys within the 'org.gnome.shell' schema.
  - It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  development-tools:
    description:
      - "
        Enable internal tools useful for developers and testers from Alt-F2
      "
      - "
        Allows access to internal debugging and monitoring tools
        using the Alt-F2 dialog.
      "
    type: bool
    default: True
  development-tools_locked:
    description:
      - "If set to true, locks the 'development-tools' key to prevent user modification."
    type: bool
    default: false
  enabled-extensions:
    description:
      - "UUIDs of extensions to enable"
      - "
        GNOME Shell extensions have a UUID property; this key lists extensions
        which should be loaded. Any extension that wants to be loaded needs
        to be in this list. You can also manipulate this list with the
        EnableExtension and DisableExtension D-Bus methods on org.gnome.Shell.
      "
    type: str
    default: '[]'
  enabled-extensions_locked:
    description:
      - "If set to true, locks the 'enabled-extensions' key to prevent user modification."
    type: bool
    default: false
  disabled-extensions:
    description:
      - "UUIDs of extensions to force disabling"
      - "
        GNOME Shell extensions have a UUID property; this key lists extensions
        which should be disabled, even if loaded as part of the current mode.
        You can also manipulate this list with the EnableExtension and
        DisableExtension D-Bus methods on org.gnome.Shell.
        This key takes precedence over the “enabled-extensions” setting.
      "
    type: str
    default: '[]'
  disabled-extensions_locked:
    description:
      - "If set to true, locks the 'disabled-extensions' key to prevent user modification."
    type: bool
    default: false
  disable-user-extensions:
    description:
      - "Disable user extensions"
      - "
        Disable all extensions the user has enabled without affecting
        the “enabled-extension” setting.
      "
    type: bool
    default: False
  disable-user-extensions_locked:
    description:
      - "If set to true, locks the 'disable-user-extensions' key to prevent user modification."
    type: bool
    default: false
  allow-extension-installation:
    description:
      - "Allow extension installation"
      - "
        Allow users to install extensions in their home folder. If disabled,
        the InstallRemoteExtension D-Bus method will fail, and extensions
        are only loaded from system directories on startup.
        It does not affect extensions that are already loaded, so a change
        only takes full effect on the next login.
      "
    type: bool
    default: True
  allow-extension-installation_locked:
    description:
      - "If set to true, locks the 'allow-extension-installation' key to prevent user modification."
    type: bool
    default: false
  disable-extension-version-validation:
    description:
      - "Disables the validation of extension version compatibility"
      - "
        GNOME Shell will only load extensions that claim to support the current
        running version. Enabling this option will disable this check and try to
        load all extensions regardless of the versions they claim to support.
      "
    type: bool
    default: False
  disable-extension-version-validation_locked:
    description:
      - "If set to true, locks the 'disable-extension-version-validation' key to prevent user modification."
    type: bool
    default: false
  favorite-apps:
    description:
      - "List of desktop file IDs for favorite applications"
      - "
        The applications corresponding to these identifiers
        will be displayed in the favorites area.
      "
    type: str
    default: '
        [
  'org.mozilla.firefox.desktop',
  'org.gnome.Calendar.desktop',
  'org.gnome.Nautilus.desktop',
  'org.gnome.Software.desktop',
  'org.gnome.TextEditor.desktop',
  'org.gnome.Calculator.desktop'
]

      '
  favorite-apps_locked:
    description:
      - "If set to true, locks the 'favorite-apps' key to prevent user modification."
    type: bool
    default: false
  command-history:
    description:
      - "History for command (Alt-F2) dialog"
      - ""
    type: str
    default: '[]'
  command-history_locked:
    description:
      - "If set to true, locks the 'command-history' key to prevent user modification."
    type: bool
    default: false
  looking-glass-history:
    description:
      - "History for the looking glass dialog"
      - ""
    type: str
    default: '[]'
  looking-glass-history_locked:
    description:
      - "If set to true, locks the 'looking-glass-history' key to prevent user modification."
    type: bool
    default: false
  always-show-log-out:
    description:
      - "Always show the “Log Out” action in the system menu"
      - "
        This key overrides the automatic hiding of the “Log out” action in the
        system menu for logged-in situations where there is a single, local,
        non-system user and only a single available session type (e.g. GNOME on
        Wayland).
      "
    type: bool
    default: False
  always-show-log-out_locked:
    description:
      - "If set to true, locks the 'always-show-log-out' key to prevent user modification."
    type: bool
    default: false
  remember-mount-password:
    description:
      - "Whether to remember password for mounting encrypted or remote filesystems"
      - "
        The shell will request a password when an encrypted device or a
        remote filesystem is mounted.  If the password can be saved for
        future use a “Remember Password” checkbox will be present.
        This key sets the default state of the checkbox.
      "
    type: bool
    default: False
  remember-mount-password_locked:
    description:
      - "If set to true, locks the 'remember-mount-password' key to prevent user modification."
    type: bool
    default: false
  last-selected-power-profile:
    description:
      - "The last selected non-default power profile"
      - "
        Some systems support more than two power profiles. In order to still support
        toggling between two profiles, this key records the last selected non-default
        profile.
      "
    type: str
    default: '"power-saver"'
  last-selected-power-profile_locked:
    description:
      - "If set to true, locks the 'last-selected-power-profile' key to prevent user modification."
    type: bool
    default: false
  welcome-dialog-last-shown-version:
    description:
      - "The last version the “Welcome to GNOME” dialog was shown for"
      - "
        This key determines for which version the “Welcome to GNOME” dialog was
        last shown. An empty string represents the oldest possible version, and
        a huge number will represent versions that do not exist yet. This huge
        number can be used to effectively disable the dialog.
      "
    type: str
    default: ''
  welcome-dialog-last-shown-version_locked:
    description:
      - "If set to true, locks the 'welcome-dialog-last-shown-version' key to prevent user modification."
    type: bool
    default: false
  app-picker-layout:
    description:
      - "Layout of the app picker"
      - "
        Layout of the app picker. Each entry in the array is a page. Pages are
        stored in the order they appear in GNOME Shell. Each page contains an
        “application id” → 'data' pair. Currently, the following values are
        stored as 'data':
          • “position”: the position of the application icon in the page
      "
    type: str
    default: '
        [{
  'org.gnome.Geary.desktop': <{'position': <0>}>,
  'org.gnome.Contacts.desktop': <{'position': <1>}>,
  'org.gnome.Weather.desktop': <{'position': <2>}>,
  'org.gnome.clocks.desktop': <{'position': <3>}>,
  'org.gnome.Maps.desktop': <{'position': <4>}>,
  'org.gnome.Music.desktop': <{'position': <5>}>,
  'simple-scan.desktop': <{'position': <6>}>,
  'org.gnome.Settings.desktop': <{'position': <7>}>,
  'org.gnome.Boxes.desktop': <{'position': <8>}>,
  'org.gnome.Totem.desktop': <{'position': <9>}>,
  'org.gnome.Snapshot.desktop': <{'position': <10>}>,
  'org.gnome.Characters.desktop': <{'position': <11>}>,
  'Utilities': <{'position': <12>}>,
  'System': <{'position': <13>}>,
  'org.gnome.Console.desktop': <{'position': <14>}>,
  'org.gnome.Tour.desktop': <{'position': <15>}>,
  'yelp.desktop': <{'position': <16>}>
}]

      '
  app-picker-layout_locked:
    description:
      - "If set to true, locks the 'app-picker-layout' key to prevent user modification."
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.shell
  org_gnome_shell:
    development-tools: True
    development-tools_locked: true
    enabled-extensions: '[]'
    enabled-extensions_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'development-tools': {
            'type': 'bool',
            'default': True
        },
        'enabled-extensions': {
            'type': 'str',
            'default': '[]'
        },
        'disabled-extensions': {
            'type': 'str',
            'default': '[]'
        },
        'disable-user-extensions': {
            'type': 'bool',
            'default': False
        },
        'allow-extension-installation': {
            'type': 'bool',
            'default': True
        },
        'disable-extension-version-validation': {
            'type': 'bool',
            'default': False
        },
        'favorite-apps': {
            'type': 'str',
            'default': '
        [
  'org.mozilla.firefox.desktop',
  'org.gnome.Calendar.desktop',
  'org.gnome.Nautilus.desktop',
  'org.gnome.Software.desktop',
  'org.gnome.TextEditor.desktop',
  'org.gnome.Calculator.desktop'
]

      '
        },
        'command-history': {
            'type': 'str',
            'default': '[]'
        },
        'looking-glass-history': {
            'type': 'str',
            'default': '[]'
        },
        'always-show-log-out': {
            'type': 'bool',
            'default': False
        },
        'remember-mount-password': {
            'type': 'bool',
            'default': False
        },
        'last-selected-power-profile': {
            'type': 'str',
            'default': '"power-saver"'
        },
        'welcome-dialog-last-shown-version': {
            'type': 'str',
            'default': ''
        },
        'app-picker-layout': {
            'type': 'str',
            'default': '
        [{
  'org.gnome.Geary.desktop': <{'position': <0>}>,
  'org.gnome.Contacts.desktop': <{'position': <1>}>,
  'org.gnome.Weather.desktop': <{'position': <2>}>,
  'org.gnome.clocks.desktop': <{'position': <3>}>,
  'org.gnome.Maps.desktop': <{'position': <4>}>,
  'org.gnome.Music.desktop': <{'position': <5>}>,
  'simple-scan.desktop': <{'position': <6>}>,
  'org.gnome.Settings.desktop': <{'position': <7>}>,
  'org.gnome.Boxes.desktop': <{'position': <8>}>,
  'org.gnome.Totem.desktop': <{'position': <9>}>,
  'org.gnome.Snapshot.desktop': <{'position': <10>}>,
  'org.gnome.Characters.desktop': <{'position': <11>}>,
  'Utilities': <{'position': <12>}>,
  'System': <{'position': <13>}>,
  'org.gnome.Console.desktop': <{'position': <14>}>,
  'org.gnome.Tour.desktop': <{'position': <15>}>,
  'yelp.desktop': <{'position': <16>}>
}]

      '
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org_gnome_shell")
    lock_file_path = os.path.join(locks_dir, "ansible-org_gnome_shell")

    schema_full_path = "/org/gnome/shell/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f"'{param_value}'"
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()