#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_terminal_legacy_settings
short_description: Manages GNOME GSettings for org.gnome.Terminal.Legacy.Settings
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.Terminal.Legacy.Settings' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.1.0"
options:
  mnemonics-enabled:
    description:
    - Whether the menubar has access keys
    - "Whether to have Alt+letter access keys for the menubar.\n        They may interfere\
      \ with some applications run inside the terminal\n        so it's possible to turn\
      \ them off."
    type: bool
    default: false

  mnemonics-enabled_locked:
    description:
    - >
      If set to true, locks the 'mnemonics-enabled' key to prevent user modification.
    type: bool
    default: false
  shortcuts-enabled:
    description:
    - Whether shortcuts are enabled
    - "Whether shortcuts are enabled.\n        They may interfere with some applications\
      \ run inside the terminal\n        so it's possible to turn them off."
    type: bool
    default: true

  shortcuts-enabled_locked:
    description:
    - >
      If set to true, locks the 'shortcuts-enabled' key to prevent user modification.
    type: bool
    default: false
  menu-accelerator-enabled:
    description:
    - Whether the standard GTK shortcut for menubar access is enabled
    - "Normally you can access the menubar with F10. This can also\n        be customized\
      \ via gtkrc (gtk-menu-bar-accel =\n        'whatever'). This option allows the standard\
      \ menubar\n        accelerator to be disabled."
    type: bool
    default: true

  menu-accelerator-enabled_locked:
    description:
    - >
      If set to true, locks the 'menu-accelerator-enabled' key to prevent user modification.
    type: bool
    default: false
  shell-integration-enabled:
    description:
    - Whether the shell integration is enabled
    - Description - Schema Blank
    type: bool
    default: true

  shell-integration-enabled_locked:
    description:
    - >
      If set to true, locks the 'shell-integration-enabled' key to prevent user modification.
    type: bool
    default: false
  confirm-close:
    description:
    - Whether to ask for confirmation before closing a terminal
    - Description - Schema Blank
    type: bool
    default: true

  confirm-close_locked:
    description:
    - >
      If set to true, locks the 'confirm-close' key to prevent user modification.
    type: bool
    default: false
  context-info:
    description:
    - Additional info section items to appear in the context menu
    - Description - Schema Blank
    type: str
    default:
    - numbers

  context-info_locked:
    description:
    - >
      If set to true, locks the 'context-info' key to prevent user modification.
    type: bool
    default: false
  default-show-menubar:
    description:
    - Whether to show the menubar in new windows
    - Description - Schema Blank
    type: bool
    default: true

  default-show-menubar_locked:
    description:
    - >
      If set to true, locks the 'default-show-menubar' key to prevent user modification.
    type: bool
    default: false
  new-terminal-mode:
    description:
    - Whether to open new terminals as windows or tabs
    - Description - Schema Blank
    type: str
    default: window

  new-terminal-mode_locked:
    description:
    - >
      If set to true, locks the 'new-terminal-mode' key to prevent user modification.
    type: bool
    default: false
  tab-policy:
    description:
    - When to show the tabs bar
    - Description - Schema Blank
    type: str
    default: automatic

  tab-policy_locked:
    description:
    - >
      If set to true, locks the 'tab-policy' key to prevent user modification.
    type: bool
    default: false
  tab-position:
    description:
    - The position of the tab bar
    - Description - Schema Blank
    type: str
    default: top

  tab-position_locked:
    description:
    - >
      If set to true, locks the 'tab-position' key to prevent user modification.
    type: bool
    default: false
  theme-variant:
    description:
    - Which theme variant to use
    - Description - Schema Blank
    type: str
    default: system

  theme-variant_locked:
    description:
    - >
      If set to true, locks the 'theme-variant' key to prevent user modification.
    type: bool
    default: false
  new-tab-position:
    description:
    - Whether new tabs should open next to the current one or at the last position
    - Description - Schema Blank
    type: str
    default: last

  new-tab-position_locked:
    description:
    - >
      If set to true, locks the 'new-tab-position' key to prevent user modification.
    type: bool
    default: false
  always-check-default-terminal:
    description:
    - Always check whether GNOME Terminal is the default terminal
    - Description - Schema Blank
    type: bool
    default: true

  always-check-default-terminal_locked:
    description:
    - >
      If set to true, locks the 'always-check-default-terminal' key to prevent user modification.
    type: bool
    default: false
  headerbar:
    description:
    - Summary - Schema Blank
    - Description - Schema Blank
    type: str
    default: null

  headerbar_locked:
    description:
    - >
      If set to true, locks the 'headerbar' key to prevent user modification.
    type: bool
    default: false
  unified-menu:
    description:
    - Summary - Schema Blank
    - Description - Schema Blank
    type: bool
    default: true

  unified-menu_locked:
    description:
    - >
      If set to true, locks the 'unified-menu' key to prevent user modification.
    type: bool
    default: false
  schema-version:
    description:
    - Summary - Schema Blank
    - Description - Schema Blank
    type: str
    default: 3

  schema-version_locked:
    description:
    - >
      If set to true, locks the 'schema-version' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.Terminal.Legacy.Settings
  org_gnome_terminal_legacy_settings:
    mnemonics-enabled: false

    shortcuts-enabled: true

    menu-accelerator-enabled: true

    shell-integration-enabled: true

    confirm-close: true

    context-info:
    - numbers

    default-show-menubar: true

    new-terminal-mode: window

    tab-policy: automatic

    tab-position: top

    theme-variant: system

    new-tab-position: last

    always-check-default-terminal: true

    headerbar: null

    unified-menu: true

    schema-version: 3

'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""
    # We have to do gross stuff with the bools here.
    keys_spec = {
        'mnemonics-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'shortcuts-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'menu-accelerator-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'shell-integration-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'confirm-close': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'context-info': {
            'default': ['numbers'],
            'type': 'str',
            'gtype':'as',
        },
        'default-show-menubar': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'new-terminal-mode': {
            'default': 'window',
            'type': 'str',
            'gtype':'s',
        },
        'tab-policy': {
            'default': 'automatic',
            'type': 'str',
            'gtype':'s',
        },
        'tab-position': {
            'default': 'top',
            'type': 'str',
            'gtype':'s',
        },
        'theme-variant': {
            'default': 'system',
            'type': 'str',
            'gtype':'s',
        },
        'new-tab-position': {
            'default': 'last',
            'type': 'str',
            'gtype':'s',
        },
        'always-check-default-terminal': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'headerbar': {
            'default': None,
            'type': 'str',
            'gtype':'mb',
        },
        'unified-menu': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'schema-version': {
            'default': 3,
            'type': 'str',
            'gtype':'u',
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org.gnome.Terminal.Legacy.Settings")
    lock_file_path = os.path.join(locks_dir, "ansible-org.gnome.Terminal.Legacy.Settings")

    schema_full_path = "/org/gnome/terminal/legacy/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
