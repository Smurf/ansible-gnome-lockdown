#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_virt-manager_virt-manager_vm
short_description: Manages GNOME GSettings for org.virt-manager.virt-manager.vm
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.virt-manager.virt-manager.vm' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  vm-window-size:
    description:
      - >
        VM window dimensions
      - >
        VM window dimensions
    type: str
    default: >
             (-1, -1)
  vm-window-size_locked:
    description:
      - >
        If set to true, locks the 'vm-window-size' key to prevent user modification.
    type: bool
    default: false
  scaling:
    description:
      - >
        When to scale the VM graphical console
      - >
        When to scale the VM graphical console. -1 = global default, 0 = never, 1 = only when in full screen mode, 2 = Always
    type: int
    default: -1
  scaling_locked:
    description:
      - >
        If set to true, locks the 'scaling' key to prevent user modification.
    type: bool
    default: false
  console-username:
    description:
      - >
        Username for graphical password
      - >
        Username for graphical password
    type: str
    default: >
             ""
  console-username_locked:
    description:
      - >
        If set to true, locks the 'console-username' key to prevent user modification.
    type: bool
    default: false
  resize-guest:
    description:
      - >
        Automatically resize guest when window size changes
      - >
        Automatically change guest resolution along with virt-manager window. Only works with spice with a vdagent set up. -1 = global default, 0 = off, 1 = on.
    type: int
    default: -1
  resize-guest_locked:
    description:
      - >
        If set to true, locks the 'resize-guest' key to prevent user modification.
    type: bool
    default: false
  autoconnect:
    description:
      - >
        Autoconnect to the default VM console when the VM window is opened
      - >
        Autoconnect to the default VM console when the VM window is opened. Users may want to turn this off if they prefer to use another viewer app for their VMs, and don't want virt-manager to interfere, but they still want to use virt-manager's details. -1 = global default, 0 = off, 1 = on
    type: int
    default: -1
  autoconnect_locked:
    description:
      - >
        If set to true, locks the 'autoconnect' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.virt-manager.virt-manager.vm
  org_virt-manager_virt-manager_vm:
    vm-window-size: "(-1, -1)"
    vm-window-size_locked: true
    scaling: -1
    scaling_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'vm-window-size': {
            'type': 'str',
            'default': "(-1, -1)"
        },
        'scaling': {
            'type': 'int',
            'default': -1
        },
        'console-username': {
            'type': 'str',
            'default': ''
        },
        'resize-guest': {
            'type': 'int',
            'default': -1
        },
        'autoconnect': {
            'type': 'int',
            'default': -1
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org.virt-manager.virt-manager.vm")
    lock_file_path = os.path.join(locks_dir, "ansible-org.virt-manager.virt-manager.vm")

    schema_full_path = "None"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
