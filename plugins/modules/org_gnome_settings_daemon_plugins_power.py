#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_settings_daemon_plugins_power
short_description: Manages GNOME GSettings for org.gnome.settings-daemon.plugins.power
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.settings-daemon.plugins.power' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.1.0"
options:
  idle-brightness:
    description:
    - The brightness of the screen when idle
    - This is the laptop panel screen brightness used when the session is idle.
    type: int
    default: 30

  idle-brightness_locked:
    description:
    - >
      If set to true, locks the 'idle-brightness' key to prevent user modification.
    type: bool
    default: false
  idle-dim:
    description:
    - Dim the screen after a period of inactivity
    - If the screen should be dimmed to save power when the computer is idle.
    type: bool
    default: true

  idle-dim_locked:
    description:
    - >
      If set to true, locks the 'idle-dim' key to prevent user modification.
    type: bool
    default: false
  sleep-inactive-ac-timeout:
    description:
    - Sleep timeout computer when on AC
    - The amount of time in seconds the computer on AC power needs to be inactive before
      it goes to sleep. A value of 0 means never.
    type: int
    default: 900

  sleep-inactive-ac-timeout_locked:
    description:
    - >
      If set to true, locks the 'sleep-inactive-ac-timeout' key to prevent user modification.
    type: bool
    default: false
  sleep-inactive-ac-type:
    description:
    - Whether to hibernate, suspend or do nothing when inactive
    - The type of sleeping that should be performed when the computer is inactive.
    type: str
    default: suspend

  sleep-inactive-ac-type_locked:
    description:
    - >
      If set to true, locks the 'sleep-inactive-ac-type' key to prevent user modification.
    type: bool
    default: false
  sleep-inactive-battery-timeout:
    description:
    - Sleep timeout computer when on battery
    - The amount of time in seconds the computer on battery power needs to be inactive
      before it goes to sleep. A value of 0 means never.
    type: int
    default: 900

  sleep-inactive-battery-timeout_locked:
    description:
    - >
      If set to true, locks the 'sleep-inactive-battery-timeout' key to prevent user modification.
    type: bool
    default: false
  sleep-inactive-battery-type:
    description:
    - Whether to hibernate, suspend or do nothing when inactive
    - The type of sleeping that should be performed when the computer is inactive.
    type: str
    default: suspend

  sleep-inactive-battery-type_locked:
    description:
    - >
      If set to true, locks the 'sleep-inactive-battery-type' key to prevent user modification.
    type: bool
    default: false
  ambient-enabled:
    description:
    - Enable the ALS sensor
    - If the ambient light sensor functionality is enabled.
    type: bool
    default: true

  ambient-enabled_locked:
    description:
    - >
      If set to true, locks the 'ambient-enabled' key to prevent user modification.
    type: bool
    default: false
  power-button-action:
    description:
    - Power button action
    - The action to take when the system power button is pressed. Virtual machines only
      honor the 'nothing' action, and will shutdown otherwise. Tablets always suspend,
      ignoring all the other action options.
    type: str
    default: suspend

  power-button-action_locked:
    description:
    - >
      If set to true, locks the 'power-button-action' key to prevent user modification.
    type: bool
    default: false
  power-saver-profile-on-low-battery:
    description:
    - Enable power-saver profile when battery is low
    - Automatically enable the 'power-saver' profile using power-profiles-daemon if the
      battery is low.
    type: bool
    default: true

  power-saver-profile-on-low-battery_locked:
    description:
    - >
      If set to true, locks the 'power-saver-profile-on-low-battery' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.settings-daemon.plugins.power
  org_gnome_settings_daemon_plugins_power:
    idle-brightness: 30

    idle-dim: true

    sleep-inactive-ac-timeout: 900

    sleep-inactive-ac-type: suspend

    sleep-inactive-battery-timeout: 900

    sleep-inactive-battery-type: suspend

    ambient-enabled: true

    power-button-action: suspend

    power-saver-profile-on-low-battery: true

'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""
    # We have to do gross stuff with the bools here.
    keys_spec = {
        'idle-brightness': {
            'default': 30,
            'type': 'int',
            'gtype':'i',
        },
        'idle-dim': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'sleep-inactive-ac-timeout': {
            'default': 900,
            'type': 'int',
            'gtype':'i',
        },
        'sleep-inactive-ac-type': {
            'default': 'suspend',
            'type': 'str',
            'gtype':'s',
        },
        'sleep-inactive-battery-timeout': {
            'default': 900,
            'type': 'int',
            'gtype':'i',
        },
        'sleep-inactive-battery-type': {
            'default': 'suspend',
            'type': 'str',
            'gtype':'s',
        },
        'ambient-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'power-button-action': {
            'default': 'suspend',
            'type': 'str',
            'gtype':'s',
        },
        'power-saver-profile-on-low-battery': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org.gnome.settings-daemon.plugins.power")
    lock_file_path = os.path.join(locks_dir, "ansible-org.gnome.settings-daemon.plugins.power")

    schema_full_path = "/org/gnome/settings-daemon/plugins/power/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
