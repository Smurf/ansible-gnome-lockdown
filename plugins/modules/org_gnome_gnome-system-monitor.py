#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_gnome-system-monitor
short_description: Manages GNOME GSettings for org.gnome.gnome-system-monitor
description:
  - This module allows for the configuration of GSettings keys within the 'org.gnome.gnome-system-monitor' schema.
  - It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  window-width:
    description:
      - "Main window width"
      - ""
    type: int
    default: 800
  window-width_locked:
    description:
      - "If set to true, locks the 'window-width' key to prevent user modification."
    type: bool
    default: false
  window-height:
    description:
      - "Main window height"
      - ""
    type: int
    default: 720
  window-height_locked:
    description:
      - "If set to true, locks the 'window-height' key to prevent user modification."
    type: bool
    default: false
  maximized:
    description:
      - "Main Window should open maximized
      "
      - ""
    type: bool
    default: False
  maximized_locked:
    description:
      - "If set to true, locks the 'maximized' key to prevent user modification."
    type: bool
    default: false
  show-dependencies:
    description:
      - "Show process dependencies in tree form
      "
      - ""
    type: bool
    default: False
  show-dependencies_locked:
    description:
      - "If set to true, locks the 'show-dependencies' key to prevent user modification."
    type: bool
    default: false
  solaris-mode:
    description:
      - "Solaris mode for CPU percentage
      "
      - "If TRUE, system-monitor operates in “Solaris mode” where a task’s CPU usage is divided by the total number of CPUs. Otherwise, it operates in “Irix mode”.
      "
    type: bool
    default: False
  solaris-mode_locked:
    description:
      - "If set to true, locks the 'solaris-mode' key to prevent user modification."
    type: bool
    default: false
  process-memory-in-iec:
    description:
      - "Show memory in IEC
      "
      - ""
    type: bool
    default: False
  process-memory-in-iec_locked:
    description:
      - "If set to true, locks the 'process-memory-in-iec' key to prevent user modification."
    type: bool
    default: false
  smooth-refresh:
    description:
      - "Enable/Disable smooth refresh
      "
      - ""
    type: bool
    default: False
  smooth-refresh_locked:
    description:
      - "If set to true, locks the 'smooth-refresh' key to prevent user modification."
    type: bool
    default: false
  kill-dialog:
    description:
      - "Show warning dialog when killing processes
      "
      - ""
    type: bool
    default: False
  kill-dialog_locked:
    description:
      - "If set to true, locks the 'kill-dialog' key to prevent user modification."
    type: bool
    default: false
  update-interval:
    description:
      - "Time in milliseconds between updates of the process view"
      - ""
    type: int
    default: 3000
  update-interval_locked:
    description:
      - "If set to true, locks the 'update-interval' key to prevent user modification."
    type: bool
    default: false
  graph-update-interval:
    description:
      - "Time in milliseconds between updates of the graphs"
      - ""
    type: int
    default: 100
  graph-update-interval_locked:
    description:
      - "If set to true, locks the 'graph-update-interval' key to prevent user modification."
    type: bool
    default: false
  show-all-fs:
    description:
      - "Whether information about all file systems should be displayed
      "
      - "Whether to display information about all file systems (including types like “autofs” and “procfs”). Useful for getting a list of all currently mounted file systems.
      "
    type: bool
    default: False
  show-all-fs_locked:
    description:
      - "If set to true, locks the 'show-all-fs' key to prevent user modification."
    type: bool
    default: false
  disks-interval:
    description:
      - "Time in milliseconds between updates of the devices list"
      - ""
    type: int
    default: 5000
  disks-interval_locked:
    description:
      - "If set to true, locks the 'disks-interval' key to prevent user modification."
    type: bool
    default: false
  graph-data-points:
    description:
      - "Time amount of data points in the resource graphs"
      - ""
    type: int
    default: 60
  graph-data-points_locked:
    description:
      - "If set to true, locks the 'graph-data-points' key to prevent user modification."
    type: bool
    default: false
  show-whose-processes:
    description:
      - "Determines which processes to show."
      - ""
    type: str
    default: 'user'
  show-whose-processes_locked:
    description:
      - "If set to true, locks the 'show-whose-processes' key to prevent user modification."
    type: bool
    default: false
  current-tab:
    description:
      - "Saves the currently viewed tab
      "
      - ""
    type: str
    default: 'resources'
  current-tab_locked:
    description:
      - "If set to true, locks the 'current-tab' key to prevent user modification."
    type: bool
    default: false
  resources-cpu-expanded:
    description:
      - "Expand CPU section on startup
      "
      - "Whether to expand the CPU section in the resources tab on startup.
      "
    type: bool
    default: False
  resources-cpu-expanded_locked:
    description:
      - "If set to true, locks the 'resources-cpu-expanded' key to prevent user modification."
    type: bool
    default: false
  resources-mem-expanded:
    description:
      - "Expand memory section on startup
      "
      - "Whether to expand the memory section in the resources tab on startup.
      "
    type: bool
    default: False
  resources-mem-expanded_locked:
    description:
      - "If set to true, locks the 'resources-mem-expanded' key to prevent user modification."
    type: bool
    default: false
  resources-net-expanded:
    description:
      - "Expand network section on startup
      "
      - "Whether to expand the network section in the resources tab on startup.
      "
    type: bool
    default: False
  resources-net-expanded_locked:
    description:
      - "If set to true, locks the 'resources-net-expanded' key to prevent user modification."
    type: bool
    default: false
  resources-disk-expanded:
    description:
      - "Expand disks section on startup
      "
      - ""
    type: bool
    default: False
  resources-disk-expanded_locked:
    description:
      - "If set to true, locks the 'resources-disk-expanded' key to prevent user modification."
    type: bool
    default: false
  cpu-colors:
    description:
      - "CPU colors
      "
      - "Each entry is in the format (CPU#, Hexadecimal color value)
      "
    type: str
    default: '[
                (0, '#e01b24'),
                (1, '#ff7800'),
                (2, '#f6d32d'),
                (3, '#33d17a'),
                (4, '#26a269'),
                (5, '#62a0ea'),
                (6, '#1c71d8'),
                (7, '#613583'),
                (8, '#9141ac'),
                (9, '#c061cb'),
                (10,'#ffbe6f'),
                (11,'#f9f06b'),
                (12,'#8ff0a4'),
                (13,'#2ec27e'),
                (14,'#1a5fb4'),
                (15,'#c061cb')
                ]'
  cpu-colors_locked:
    description:
      - "If set to true, locks the 'cpu-colors' key to prevent user modification."
    type: bool
    default: false
  mem-color:
    description:
      - "Default graph memory color
      "
      - ""
    type: str
    default: '#e01b24'
      '
  mem-color_locked:
    description:
      - "If set to true, locks the 'mem-color' key to prevent user modification."
    type: bool
    default: false
  swap-color:
    description:
      - "Default graph swap color
      "
      - ""
    type: str
    default: '#33d17a'
      '
  swap-color_locked:
    description:
      - "If set to true, locks the 'swap-color' key to prevent user modification."
    type: bool
    default: false
  net-in-color:
    description:
      - "Default graph incoming network traffic color
      "
      - ""
    type: str
    default: '#3584e4'
      '
  net-in-color_locked:
    description:
      - "If set to true, locks the 'net-in-color' key to prevent user modification."
    type: bool
    default: false
  net-out-color:
    description:
      - "Default graph outgoing network traffic color
      "
      - ""
    type: str
    default: '#e66100'
      '
  net-out-color_locked:
    description:
      - "If set to true, locks the 'net-out-color' key to prevent user modification."
    type: bool
    default: false
  disk-read-color:
    description:
      - "Default graph disk read color
      "
      - ""
    type: str
    default: '#3584e4'
      '
  disk-read-color_locked:
    description:
      - "If set to true, locks the 'disk-read-color' key to prevent user modification."
    type: bool
    default: false
  disk-write-color:
    description:
      - "Default graph disk write color
      "
      - ""
    type: str
    default: '#e66100'
      '
  disk-write-color_locked:
    description:
      - "If set to true, locks the 'disk-write-color' key to prevent user modification."
    type: bool
    default: false
  network-in-bits:
    description:
      - "Show network traffic in bits
      "
      - ""
    type: bool
    default: False
  network-in-bits_locked:
    description:
      - "If set to true, locks the 'network-in-bits' key to prevent user modification."
    type: bool
    default: false
  network-total-in-bits:
    description:
      - "Show network totals in bits
      "
      - ""
    type: bool
    default: False
  network-total-in-bits_locked:
    description:
      - "If set to true, locks the 'network-total-in-bits' key to prevent user modification."
    type: bool
    default: false
  logarithmic-scale:
    description:
      - "Show memory in logarithmic scale
      "
      - "If TRUE, system-monitor shows the CPU chart as a stacked area chart instead of a line chart.
      "
    type: bool
    default: False
  logarithmic-scale_locked:
    description:
      - "If set to true, locks the 'logarithmic-scale' key to prevent user modification."
    type: bool
    default: false
  cpu-stacked-area-chart:
    description:
      - "Show CPU chart as stacked area chart
      "
      - "If TRUE, system-monitor shows the CPU chart as a stacked area chart instead of a line chart.
      "
    type: bool
    default: False
  cpu-stacked-area-chart_locked:
    description:
      - "If set to true, locks the 'cpu-stacked-area-chart' key to prevent user modification."
    type: bool
    default: false
  cpu-smooth-graph:
    description:
      - "Show CPU, Memory, Network, and Disk charts as smooth graphs using Bezier curves
      "
      - "If TRUE, system-monitor shows the CPU, Memory, Network, and Disk charts as smoothed graphs, otherwise as line charts.
      "
    type: bool
    default: False
  cpu-smooth-graph_locked:
    description:
      - "If set to true, locks the 'cpu-smooth-graph' key to prevent user modification."
    type: bool
    default: false
  resources-memory-in-iec:
    description:
      - "Show memory and swap in IEC
      "
      - ""
    type: bool
    default: False
  resources-memory-in-iec_locked:
    description:
      - "If set to true, locks the 'resources-memory-in-iec' key to prevent user modification."
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.gnome-system-monitor
  org_gnome_gnome-system-monitor:
    window-width: 800
    window-width_locked: true
    window-height: 720
    window-height_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'window-width': {
            'type': 'int',
            'default': 800
        },
        'window-height': {
            'type': 'int',
            'default': 720
        },
        'maximized': {
            'type': 'bool',
            'default': False
        },
        'show-dependencies': {
            'type': 'bool',
            'default': False
        },
        'solaris-mode': {
            'type': 'bool',
            'default': False
        },
        'process-memory-in-iec': {
            'type': 'bool',
            'default': False
        },
        'smooth-refresh': {
            'type': 'bool',
            'default': False
        },
        'kill-dialog': {
            'type': 'bool',
            'default': False
        },
        'update-interval': {
            'type': 'int',
            'default': 3000
        },
        'graph-update-interval': {
            'type': 'int',
            'default': 100
        },
        'show-all-fs': {
            'type': 'bool',
            'default': False
        },
        'disks-interval': {
            'type': 'int',
            'default': 5000
        },
        'graph-data-points': {
            'type': 'int',
            'default': 60
        },
        'show-whose-processes': {
            'type': 'str',
            'default': 'user'
        },
        'current-tab': {
            'type': 'str',
            'default': 'resources'
        },
        'resources-cpu-expanded': {
            'type': 'bool',
            'default': False
        },
        'resources-mem-expanded': {
            'type': 'bool',
            'default': False
        },
        'resources-net-expanded': {
            'type': 'bool',
            'default': False
        },
        'resources-disk-expanded': {
            'type': 'bool',
            'default': False
        },
        'cpu-colors': {
            'type': 'str',
            'default': '[
                (0, '#e01b24'),
                (1, '#ff7800'),
                (2, '#f6d32d'),
                (3, '#33d17a'),
                (4, '#26a269'),
                (5, '#62a0ea'),
                (6, '#1c71d8'),
                (7, '#613583'),
                (8, '#9141ac'),
                (9, '#c061cb'),
                (10,'#ffbe6f'),
                (11,'#f9f06b'),
                (12,'#8ff0a4'),
                (13,'#2ec27e'),
                (14,'#1a5fb4'),
                (15,'#c061cb')
                ]'
        },
        'mem-color': {
            'type': 'str',
            'default': '#e01b24'
      '
        },
        'swap-color': {
            'type': 'str',
            'default': '#33d17a'
      '
        },
        'net-in-color': {
            'type': 'str',
            'default': '#3584e4'
      '
        },
        'net-out-color': {
            'type': 'str',
            'default': '#e66100'
      '
        },
        'disk-read-color': {
            'type': 'str',
            'default': '#3584e4'
      '
        },
        'disk-write-color': {
            'type': 'str',
            'default': '#e66100'
      '
        },
        'network-in-bits': {
            'type': 'bool',
            'default': False
        },
        'network-total-in-bits': {
            'type': 'bool',
            'default': False
        },
        'logarithmic-scale': {
            'type': 'bool',
            'default': False
        },
        'cpu-stacked-area-chart': {
            'type': 'bool',
            'default': False
        },
        'cpu-smooth-graph': {
            'type': 'bool',
            'default': False
        },
        'resources-memory-in-iec': {
            'type': 'bool',
            'default': False
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org_gnome_gnome-system-monitor")
    lock_file_path = os.path.join(locks_dir, "ansible-org_gnome_gnome-system-monitor")

    schema_full_path = "/org/gnome/gnome-system-monitor/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f"'{param_value}'"
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()