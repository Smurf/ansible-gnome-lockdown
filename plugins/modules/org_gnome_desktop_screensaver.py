#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_desktop_screensaver
short_description: Manages GNOME GSettings for org.gnome.desktop.screensaver
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.desktop.screensaver' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.1.0"
options:
  idle-activation-enabled:
    description:
    - Activate when idle
    - "Set this to TRUE to activate the screensaver when the session is idle.\n\n    \
      \    DEPRECATED: This key is deprecated and ignored.\n        Set org.gnome.desktop.session\
      \ idle-delay to 0 if you do not want to activate the screensaver."
    type: bool
    default: true

  idle-activation-enabled_locked:
    description:
    - >
      If set to true, locks the 'idle-activation-enabled' key to prevent user modification.
    type: bool
    default: false
  lock-enabled:
    description:
    - Lock on activation
    - Set this to TRUE to lock the screen when the screensaver goes active.
    type: bool
    default: true

  lock-enabled_locked:
    description:
    - >
      If set to true, locks the 'lock-enabled' key to prevent user modification.
    type: bool
    default: false
  lock-delay:
    description:
    - Time before locking
    - The number of seconds after screensaver activation before locking the screen.
    type: str
    default: 0

  lock-delay_locked:
    description:
    - >
      If set to true, locks the 'lock-delay' key to prevent user modification.
    type: bool
    default: false
  show-full-name-in-top-bar:
    description:
    - Show full name in the lock screen
    - Whether the user's full name is shown in the lock screen or not. This only affects
      the screen shield, the name is always shown in the unlock dialog.
    type: bool
    default: true

  show-full-name-in-top-bar_locked:
    description:
    - >
      If set to true, locks the 'show-full-name-in-top-bar' key to prevent user modification.
    type: bool
    default: false
  embedded-keyboard-enabled:
    description:
    - Allow embedding a keyboard into the window
    - "Set this to TRUE to allow embedding a keyboard into the window when trying to unlock.\
      \  The 'keyboard_command' key must be set with the appropriate command.\n\n    \
      \    DEPRECATED: This key is deprecated and ignored."
    type: bool
    default: false

  embedded-keyboard-enabled_locked:
    description:
    - >
      If set to true, locks the 'embedded-keyboard-enabled' key to prevent user modification.
    type: bool
    default: false
  embedded-keyboard-command:
    description:
    - Embedded keyboard command
    - "The command that will be run, if the 'embedded_keyboard_enabled' key is set to\
      \ TRUE, to embed a keyboard widget into the window. This command should implement\
      \ an XEMBED plug interface and output a window XID on the standard output.\n\n \
      \       DEPRECATED: This key is deprecated and ignored."
    type: str
    default: ''

  embedded-keyboard-command_locked:
    description:
    - >
      If set to true, locks the 'embedded-keyboard-command' key to prevent user modification.
    type: bool
    default: false
  logout-enabled:
    description:
    - Allow logout
    - "Set this to TRUE to offer an option in the unlock dialog to allow logging out after\
      \ a delay.  The delay is specified in the 'logout_delay' key.\n\n        DEPRECATED:\
      \ This key is deprecated and ignored."
    type: bool
    default: false

  logout-enabled_locked:
    description:
    - >
      If set to true, locks the 'logout-enabled' key to prevent user modification.
    type: bool
    default: false
  logout-delay:
    description:
    - Time before logout option
    - "The number of seconds after the screensaver activation before a logout option will\
      \ appear in the unlock dialog. This key has effect only if the 'logout_enable' key\
      \ is set to TRUE.\n\n        DEPRECATED: This key is deprecated and ignored"
    type: str
    default: 7200

  logout-delay_locked:
    description:
    - >
      If set to true, locks the 'logout-delay' key to prevent user modification.
    type: bool
    default: false
  logout-command:
    description:
    - Logout command
    - "The command to invoke when the logout button is clicked.  This command should simply\
      \ log the user out without any interaction. This key has effect only if the 'logout_enable'\
      \ key is set to TRUE.\n\n        DEPRECATED: This key is deprecated and ignored."
    type: str
    default: ''

  logout-command_locked:
    description:
    - >
      If set to true, locks the 'logout-command' key to prevent user modification.
    type: bool
    default: false
  user-switch-enabled:
    description:
    - Allow user switching
    - Set this to TRUE to offer an option in the unlock dialog to switch to a different
      user account.
    type: bool
    default: true

  user-switch-enabled_locked:
    description:
    - >
      If set to true, locks the 'user-switch-enabled' key to prevent user modification.
    type: bool
    default: false
  status-message-enabled:
    description:
    - Allow the session status message to be displayed
    - "Allow the session status message to be displayed when the screen is locked.\n\n\
      \        DEPRECATED: This key is deprecated and ignored."
    type: bool
    default: true

  status-message-enabled_locked:
    description:
    - >
      If set to true, locks the 'status-message-enabled' key to prevent user modification.
    type: bool
    default: false
  picture-options:
    description:
    - Picture Options
    - "Determines how the image set by wallpaper_filename is rendered.\n        Possible\
      \ values are 'none', 'wallpaper', 'centered', 'scaled',\n        'stretched', 'zoom',\
      \ 'spanned'."
    type: str
    default: zoom

  picture-options_locked:
    description:
    - >
      If set to true, locks the 'picture-options' key to prevent user modification.
    type: bool
    default: false
  picture-uri:
    description:
    - Picture URI
    - "URI to use for the background image. Note that the backend only supports\n    \
      \    local (file://) URIs."
    type: str
    default: file:///usr/share/backgrounds/gnome/adwaita-timed.xml

  picture-uri_locked:
    description:
    - >
      If set to true, locks the 'picture-uri' key to prevent user modification.
    type: bool
    default: false
  picture-opacity:
    description:
    - Picture Opacity
    - Opacity with which to draw the background picture.
    type: int
    default: 100

  picture-opacity_locked:
    description:
    - >
      If set to true, locks the 'picture-opacity' key to prevent user modification.
    type: bool
    default: false
  primary-color:
    description:
    - Primary Color
    - Left or Top color when drawing gradients, or the solid color.
    type: str
    default: '#023c88'

  primary-color_locked:
    description:
    - >
      If set to true, locks the 'primary-color' key to prevent user modification.
    type: bool
    default: false
  secondary-color:
    description:
    - Secondary Color
    - Right or Bottom color when drawing gradients, not used for solid color.
    type: str
    default: '#5789ca'

  secondary-color_locked:
    description:
    - >
      If set to true, locks the 'secondary-color' key to prevent user modification.
    type: bool
    default: false
  color-shading-type:
    description:
    - Color Shading Type
    - "How to shade the background color. Possible values are 'horizontal',\n        'vertical',\
      \ and 'solid'."
    type: str
    default: solid

  color-shading-type_locked:
    description:
    - >
      If set to true, locks the 'color-shading-type' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.desktop.screensaver
  org_gnome_desktop_screensaver:
    idle-activation-enabled: true

    lock-enabled: true

    lock-delay: 0

    show-full-name-in-top-bar: true

    embedded-keyboard-enabled: false

    embedded-keyboard-command: ''

    logout-enabled: false

    logout-delay: 7200

    logout-command: ''

    user-switch-enabled: true

    status-message-enabled: true

    picture-options: zoom

    picture-uri: file:///usr/share/backgrounds/gnome/adwaita-timed.xml

    picture-opacity: 100

    primary-color: '#023c88'

    secondary-color: '#5789ca'

    color-shading-type: solid

'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""
    # We have to do gross stuff with the bools here.
    keys_spec = {
        'idle-activation-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'lock-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'lock-delay': {
            'default': 0,
            'type': 'str',
            'gtype':'u',
        },
        'show-full-name-in-top-bar': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'embedded-keyboard-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'embedded-keyboard-command': {
            'default': '',
            'type': 'str',
            'gtype':'s',
        },
        'logout-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'logout-delay': {
            'default': 7200,
            'type': 'str',
            'gtype':'u',
        },
        'logout-command': {
            'default': '',
            'type': 'str',
            'gtype':'s',
        },
        'user-switch-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'status-message-enabled': {
            'default': False,
            'type': 'bool',
            'gtype':'b',
        },
        'picture-options': {
            'default': 'zoom',
            'type': 'str',
            'gtype':'s',
        },
        'picture-uri': {
            'default': 'file:///usr/share/backgrounds/gnome/adwaita-timed.xml',
            'type': 'str',
            'gtype':'s',
        },
        'picture-opacity': {
            'default': 100,
            'type': 'int',
            'gtype':'i',
        },
        'primary-color': {
            'default': '#023c88',
            'type': 'str',
            'gtype':'s',
        },
        'secondary-color': {
            'default': '#5789ca',
            'type': 'str',
            'gtype':'s',
        },
        'color-shading-type': {
            'default': 'solid',
            'type': 'str',
            'gtype':'s',
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org.gnome.desktop.screensaver")
    lock_file_path = os.path.join(locks_dir, "ansible-org.gnome.desktop.screensaver")

    schema_full_path = "/org/gnome/desktop/screensaver/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
