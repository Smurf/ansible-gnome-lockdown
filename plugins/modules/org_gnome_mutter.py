#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright (c) 2023, Jules
# All rights reserved.

from __future__ import absolute_import, division, print_function
__metaclass__ = type

DOCUMENTATION = r'''
---
module: org_gnome_mutter
short_description: Manages GNOME GSettings for org.gnome.mutter
description:
  - >
    This module allows for the configuration of GSettings keys within the 'org.gnome.mutter' schema.
  - >
    It supports setting default values and locking keys to enforce system-wide policies.
author:
  - Autogenerated by ansible-gnome-lockdown
version_added: "1.0.0"
options:
  overlay-key:
    description:
      - >
        Modifier to use for extended window management operations
      - >
        This key will initiate the “overlay”, which is a combination window overview and application launching system. The default is intended to be the “Windows key” on PC hardware. It’s expected that this binding either the default or set to the empty string.
    type: str
    default: >
             Super
  overlay-key_locked:
    description:
      - >
        If set to true, locks the 'overlay-key' key to prevent user modification.
    type: bool
    default: false
  attach-modal-dialogs:
    description:
      - >
        Attach modal dialogs
      - >
        When true, instead of having independent titlebars, modal dialogs appear attached to the titlebar of the parent window and are moved together with the parent window.
    type: bool
    default: false
  attach-modal-dialogs_locked:
    description:
      - >
        If set to true, locks the 'attach-modal-dialogs' key to prevent user modification.
    type: bool
    default: false
  edge-tiling:
    description:
      - >
        Enable edge tiling when dropping windows on screen edges
      - >
        If enabled, dropping windows on vertical screen edges maximizes them vertically and resizes them horizontally to cover half of the available area. Dropping windows on the top screen edge maximizes them completely.
    type: bool
    default: false
  edge-tiling_locked:
    description:
      - >
        If set to true, locks the 'edge-tiling' key to prevent user modification.
    type: bool
    default: false
  dynamic-workspaces:
    description:
      - >
        Workspaces are managed dynamically
      - >
        Determines whether workspaces are managed dynamically or whether there’s a static number of workspaces (determined by the num-workspaces key in org.gnome.desktop.wm.preferences).
    type: bool
    default: false
  dynamic-workspaces_locked:
    description:
      - >
        If set to true, locks the 'dynamic-workspaces' key to prevent user modification.
    type: bool
    default: false
  workspaces-only-on-primary:
    description:
      - >
        Workspaces only on primary
      - >
        Determines whether workspace switching should happen for windows on all monitors or only for windows on the primary monitor.
    type: bool
    default: false
  workspaces-only-on-primary_locked:
    description:
      - >
        If set to true, locks the 'workspaces-only-on-primary' key to prevent user modification.
    type: bool
    default: false
  focus-change-on-pointer-rest:
    description:
      - >
        Delay focus changes until the pointer stops moving
      - >
        If set to true, and the focus mode is either “sloppy” or “mouse” then the focus will not be changed immediately when entering a window, but only after the pointer stops moving.
    type: bool
    default: false
  focus-change-on-pointer-rest_locked:
    description:
      - >
        If set to true, locks the 'focus-change-on-pointer-rest' key to prevent user modification.
    type: bool
    default: false
  draggable-border-width:
    description:
      - >
        Draggable border width
      - >
        The amount of total draggable borders. If the theme’s visible borders are not enough, invisible borders will be added to meet this value.
    type: int
    default: 10
  draggable-border-width_locked:
    description:
      - >
        If set to true, locks the 'draggable-border-width' key to prevent user modification.
    type: bool
    default: false
  auto-maximize:
    description:
      - >
        Auto maximize nearly monitor sized windows
      - >
        If enabled, new windows that are initially the size of the monitor automatically get maximized.
    type: bool
    default: true
  auto-maximize_locked:
    description:
      - >
        If set to true, locks the 'auto-maximize' key to prevent user modification.
    type: bool
    default: false
  center-new-windows:
    description:
      - >
        Place new windows in the center
      - >
        When true, the new windows will always be put in the center of the active screen of the monitor.
    type: bool
    default: true
  center-new-windows_locked:
    description:
      - >
        If set to true, locks the 'center-new-windows' key to prevent user modification.
    type: bool
    default: false
  experimental-features:
    description:
      - >
        Enable experimental features
      - >
        To enable experimental features, add the feature keyword to the list. Whether the feature requires restarting the compositor depends on the given feature. Any experimental feature is not required to still be available, or configurable. Don’t expect adding anything in this setting to be future proof. Currently possible keywords: • “scale-monitor-framebuffer” — makes mutter default to layout logical monitors in a logical pixel coordinate space, while scaling monitor framebuffers instead of window content, to manage HiDPI monitors. Does not require a restart. • “kms-modifiers” — makes mutter always allocate scanout buffers with explicit modifiers, if supported by the driver. Requires a restart. • “autoclose-xwayland” — automatically terminates Xwayland if all relevant X11 clients are gone. Requires a restart. • “variable-refresh-rate” — makes mutter dynamically adjust the refresh rate of the monitor when applicable if supported by the monitor, GPU and DRM driver. Configurable in Settings. Requires a restart. • “xwayland-native-scaling” — lets Xwayland clients use their native scaling support. If scaling is not supported by client, the client will be unscaled. Setting only takes effect when “scale-monitor-framebuffer” is enabled as well.
    type: str
    default: >
             []
  experimental-features_locked:
    description:
      - >
        If set to true, locks the 'experimental-features' key to prevent user modification.
    type: bool
    default: false
  locate-pointer-key:
    description:
      - >
        Modifier to use to locate the pointer
      - >
        This key will initiate the “locate pointer” action.
    type: str
    default: >
             Control_L
  locate-pointer-key_locked:
    description:
      - >
        If set to true, locks the 'locate-pointer-key' key to prevent user modification.
    type: bool
    default: false
  check-alive-timeout:
    description:
      - >
        Timeout for check-alive ping
      - >
        Number of milliseconds a client has to respond to a ping request in order to not be detected as frozen. Using 0 will disable the alive check completely.
    type: str
    default: >
             5000
  check-alive-timeout_locked:
    description:
      - >
        If set to true, locks the 'check-alive-timeout' key to prevent user modification.
    type: bool
    default: false
  output-luminance:
    description:
      - >
        Per output luminance settings
      - >
        Per output and color mode luminance setting. Each entry consists of a tuple with connector, vendor, product, serial, and a color mode, as well as an associated floating point value representing the output luminance in percent (%). The default when not specified is 100%.
    type: str
    default: >
             []
  output-luminance_locked:
    description:
      - >
        If set to true, locks the 'output-luminance' key to prevent user modification.
    type: bool
    default: false
'''

EXAMPLES = r'''
- name: Configure and lock GNOME desktop settings for org.gnome.mutter
  org_gnome_mutter:
    overlay-key: "Super"
    overlay-key_locked: true
    attach-modal-dialogs: false
    attach-modal-dialogs_locked: true
'''

RETURN = r'''
# Default return values
'''

from ansible.module_utils.basic import AnsibleModule
import os
import configparser

def main():
    """Main function for the Ansible module."""

    keys_spec = {
        'overlay-key': {
            'type': 'str',
            'default': "Super"
        },
        'attach-modal-dialogs': {
            'type': 'bool',
            'default': True
        },
        'edge-tiling': {
            'type': 'bool',
            'default': True
        },
        'dynamic-workspaces': {
            'type': 'bool',
            'default': True
        },
        'workspaces-only-on-primary': {
            'type': 'bool',
            'default': True
        },
        'focus-change-on-pointer-rest': {
            'type': 'bool',
            'default': True
        },
        'draggable-border-width': {
            'type': 'int',
            'default': 10
        },
        'auto-maximize': {
            'type': 'bool',
            'default': True
        },
        'center-new-windows': {
            'type': 'bool',
            'default': True
        },
        'experimental-features': {
            'type': 'str',
            'default': "[]"
        },
        'locate-pointer-key': {
            'type': 'str',
            'default': "Control_L"
        },
        'check-alive-timeout': {
            'type': 'str',
            'default': "5000"
        },
        'output-luminance': {
            'type': 'str',
            'default': "[]"
        },
    }

    argument_spec = {}
    for key_name, spec in keys_spec.items():
        argument_spec[key_name] = spec
        argument_spec[f"{key_name}_locked"] = {'type': 'bool', 'default': False}

    module = AnsibleModule(
        argument_spec=argument_spec,
        supports_check_mode=True
    )

    changed = False

    settings_dir = "/etc/dconf/db/local.d"
    locks_dir = os.path.join(settings_dir, "locks")

    settings_file_path = os.path.join(settings_dir, "00-ansible-org_gnome_mutter")
    lock_file_path = os.path.join(locks_dir, "ansible-org_gnome_mutter")

    schema_full_path = "/org/gnome/mutter/"
    config_section = schema_full_path.strip('/')

    os.makedirs(settings_dir, exist_ok=True)
    os.makedirs(locks_dir, exist_ok=True)

    # Idempotency: Read current settings
    current_settings = configparser.ConfigParser()
    if os.path.exists(settings_file_path):
        current_settings.read(settings_file_path)

    # Idempotency: Read current locks from our dedicated lock file
    current_locks = []
    if os.path.exists(lock_file_path):
        with open(lock_file_path, 'r') as f:
            current_locks = [line.strip() for line in f if line.strip()]

    # Prepare settings and locks based on module parameters
    new_settings = configparser.ConfigParser()
    new_settings.add_section(config_section)
    new_locks = []

    for key_name, spec in keys_spec.items():
        param_value = module.params[key_name]
        param_locked = module.params[f"{key_name}_locked"]

        if spec['type'] == 'bool':
            setting_value = str(param_value).lower()
        elif spec['type'] == 'str':
            setting_value = f'{param_value}'
        else:
            setting_value = str(param_value)

        new_settings.set(config_section, key_name, setting_value)

        if param_locked:
            new_locks.append(f"{schema_full_path}{key_name}")

    # Check for changes
    settings_changed = False
    if not current_settings.has_section(config_section) or \
       (current_settings.has_section(config_section) and dict(current_settings.items(config_section)) != dict(new_settings.items(config_section))):
        settings_changed = True

    locks_changed = sorted(new_locks) != sorted(current_locks)

    if settings_changed or locks_changed:
        changed = True

    if changed and not module.check_mode:
        # Write settings file
        with open(settings_file_path, 'w') as f:
            new_settings.write(f, space_around_delimiters=False)

        # Manage the dedicated lock file
        if new_locks:
            with open(lock_file_path, 'w') as f:
                for lock_key in new_locks:
                    f.write(f"{lock_key}\n")
        elif os.path.exists(lock_file_path):
            os.remove(lock_file_path)

        # Update dconf database
        module.run_command(["dconf", "update"], check_rc=True)

    module.exit_json(changed=changed)

if __name__ == '__main__':
    main()
